<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EchoHeart Diary Login</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Nunito', sans-serif;
  background: linear-gradient(135deg, #ffe4e1, #e6e6fa);
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}
.login-box {
  background: #fff;
  padding: 30px 40px;
  border-radius: 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  text-align: center;
  width: 320px;
}
h1 {
  color: #B76E79;
  margin-bottom: 10px;
}
p {
  color: #5A5A5A;
  margin-bottom: 20px;
}
input {
  width: 100%;
  padding: 10px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 1em;
  margin-bottom: 15px;
}
button {
  width: 100%;
  padding: 10px;
  background: #B76E79;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1em;
  cursor: pointer;
  font-weight: 600;
}
button:hover {
  background: #a45c68;
}
#msg {
  margin-top: 10px;
  color: #B76E79;
  font-weight: bold;
}
</style>
</head>
<body>
  <div class="login-box">
    <h1>ðŸ”’ EchoHeart Diary</h1>
    <p id="desc">Checking user...</p>
    <input type="password" id="password" placeholder="Enter Password" style="display:none;">
    <button id="loginBtn" style="display:none;">Proceed</button>
    <p id="msg"></p>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
  const desc = document.getElementById('desc');
  const passInput = document.getElementById('password');
  const loginBtn = document.getElementById('loginBtn');
  const msg = document.getElementById('msg');

  const currentUser = localStorage.getItem('currentUser');
  if (!currentUser) {
    desc.textContent = "Please log in to your EchoHeart account first.";
  } else {
    // Get user data
    let users = JSON.parse(localStorage.getItem('users')) || {};
    let userData = users[currentUser] || {};

    const storedHash = userData.diaryPasswordHash;

    if (!storedHash) {
      desc.textContent = "Set a new password for your diary";
      loginBtn.textContent = "Set Password";
    } else {
      desc.textContent = "Enter your diary password";
      loginBtn.textContent = "Unlock";
    }

    passInput.style.display = "block";
    loginBtn.style.display = "block";

    loginBtn.onclick = () => {
      const password = passInput.value.trim();
      if (!password) {
        msg.textContent = "Please enter a password.";
        return;
      }

      if (!storedHash) {
        // Set new password for this user
        const hash = CryptoJS.SHA256(password).toString();
        if (!users[currentUser]) users[currentUser] = {};
        users[currentUser].diaryPasswordHash = hash;
        localStorage.setItem('users', JSON.stringify(users));

        sessionStorage.setItem('diarySessionKey', password);
        window.location.href = 'diary.html';
      } else {
        // Verify password
        const hash = CryptoJS.SHA256(password).toString();
        if (hash === storedHash) {
          sessionStorage.setItem('diarySessionKey', password);
          window.location.href = 'diary.html';
        } else {
          msg.textContent = "Incorrect password!";
        }
      }
    };
  }
  </script>
</body>
</html>
